Firmware OTA
================

芯片上电后，从BOOT ROM启动，跳转到Flash的Second Bootloader(SBL)执行，SBL检查Flash最后一个区域OTA SETTINGS的内容，决定是否需要进行OTA固件升级。

如果不需要升级，则跳转到应用执行。如果需要升级，则初始化BLE协议栈，加载FOTA Service，开启广播，等待建立连接，更新固件。



使用
---------

#. 进入OTA状态


    - 应用根据需求通过调用 ``request_ota_reboot()`` 函数进入OTA状态。

    - 该函数首先在Flash OTA SETTINGS区域写入OTA请求信息，然后复位重启，开始广播，请求建立连接执行OTA。


#. 手机连接，升级固件

    - 在确认芯片进入OTA状态后，手机打开系统蓝牙，打开BLE_FOTA应用，点击Refresh按键扫描广播设备，点击需要OTA的设备建立连接。

    - 连接建立，服务发现成功后，可以选择新的固件镜像，若需验证固件签名，要同时选择签名文件，然后Start FOTA。升级完成后，看到status = 0，意味升级成功。


单、双区OTA
-------------

根据 :ref:`memory` 一节的介绍，用户应用位于SECOND BOOTLOADER之后和PERSISTENT DATA之前的空间里，这部分空间在250KB左右。

若应用较小，此空间可以容纳两个固件，那么OTA时，可以将此空间一分为二，老固件在前一半，新固件存放到后一半。新固件传输、校验完成后，系统会将老固件擦除，把新固件搬移到老固件的地址上。若升级过程中突然失败，可以选择重启后从老固件启动，也可以选择重启后维持OTA状态，等待更新。

若应用较大，此空间无法容纳两个固件，那么OTA时，会先将老固件擦除，新固件直接写入老固件地址上。若升级过程中突然失败，则只能重启后维持OTA状态，等待更新。






固件签名
-------------